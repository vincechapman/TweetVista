{% macro campaign_selection_macro(campaigns) %}

    <div class="dropdown" id="client-selection-dropdown" style="display: none;">
        <div class="dropdown-trigger">
            <button class="input" aria-haspopup="true" aria-controls="dropdown-menu">
                <span id="client-dropdown-placeholder">Client</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu" role="menu">
            <div class="dropdown-content">
                {% for campaign in campaigns %}
                    <a class="dropdown-item">
                        {{ campaign['name'] }}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="dropdown" id="campaign-selection-dropdown">
        <div class="dropdown-trigger">
            <button class="input" aria-haspopup="true" aria-controls="dropdown-menu">
                <span id="campaign-dropdown-placeholder">Campaign</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu" role="menu">
            <div class="dropdown-content">
                <div class="dropdown-item has-text-info" id="campaign-filter-message">
                    Showing campaigns for all clients
                </div>
                <hr class="dropdown-divider">
                {% for campaign in campaigns %}
                    <a class="dropdown-item campaign" data-client="{{ campaign['name'] }}" data-campaign="{{ campaign['id'] }}">
                        {{ campaign['id'] }}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>

        // Displays client dropdown only if JS is available
        document.getElementById('client-selection-dropdown').style.display = 'inline-flex'

        // Adding toggle for dropdown menus
        const dropDowns = document.getElementsByClassName('dropdown')
        function toggleDropdown() {
            this.classList.toggle('is-active')
        }
        for (let i = 0; i < dropDowns.length; i++) {
            dropDowns[i].addEventListener('click', toggleDropdown, false);
        }

        // Adding ability to filter campaigns by client
        const clients = document.querySelectorAll('#client-selection-dropdown > .dropdown-menu > .dropdown-content > .dropdown-item')
        const campaigns = document.querySelectorAll('#campaign-selection-dropdown > .dropdown-menu > .dropdown-content > .dropdown-item.campaign')
        const originalCampaignFilterMessage = document.getElementById('campaign-filter-message').innerHTML

        function removeClientFilter() {
            for (let i = 0; i < campaigns.length; i++) {
                campaigns[i].style.display = 'block'
            }
            for (let i = 0; i < clients.length; i++) {
                clients[i].classList.remove('is-active')
            }

            // Set text back to default
            document.getElementById('campaign-filter-message').innerHTML = originalCampaignFilterMessage
            document.getElementById('client-dropdown-placeholder').innerText = 'Client'

        }

        function selectClientFilter() {

            let chosen_client = this.innerText

            // Sets dropdown placeholder to chosen client
            document.getElementById('client-dropdown-placeholder').innerText = chosen_client

            // Setting chosen client to active styling
            for (let i = 0; i < clients.length; i++) {
                if (clients[i] === this) {
                    clients[i].classList.add('is-active')
                } else {
                    clients[i].classList.remove('is-active')
                }
            }

            // Hides all but selected client campaigns, plus changes message at the top.
            document.getElementById('campaign-filter-message').innerHTML = `Only showing campaigns for ${chosen_client} <div id="remove-filter-button" onclick="removeClientFilter()">Remove filter?</div>`
            for (let i = 0; i < campaigns.length; i++) {
                if (campaigns[i].getAttribute('data-client') === chosen_client) {
                    campaigns[i].style.display = 'block'
                } else {
                    campaigns[i].style.display = 'none'
                }
            }
        }

        // Event listener to check if a client has been clicked
        for (let i = 0; i < clients.length; i++) {
            clients[i].addEventListener('click', selectClientFilter, false);
        }



        // Event listener to check if a campaign has been clicked
        for (let i = 0; i < campaigns.length; i++) {
            campaigns[i].addEventListener('click', campaignClick, false);
        }

        function campaignClick() {

            document.getElementById('campaign-dropdown-placeholder').innerHTML = this.innerHTML

            // Setting chosen client to active styling
            for (let i = 0; i < campaigns.length; i++) {
                if (campaigns[i] === this) {
                    campaigns[i].classList.add('is-active')
                } else {
                    campaigns[i].classList.remove('is-active')
                }
            }

            // Call api
            fetch('{{ url_for('api.get_stream') }}', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'client': this.getAttribute('data-client'),
                    'campaign': this.getAttribute('data-campaign')
                })
                })
                // Retrieve its body as ReadableStream
                .then(async (response) => {
                    const reader = response.body.getReader();
                    let count = 0
                    while (true) {

                        count += 1

                        const {value, done} = await reader.read()
                        if (done) {
                            console.log('Stream closed')
                            break
                        }

                        let newValue = ''
                        for (let i = 0; i < value.length; i++) {
                            newValue += String.fromCharCode(value[i])
                        }
                        try {
                            newValue = JSON.parse(newValue)
                            create_new_html_object(newValue)
                        } catch(SyntaxError) {
                        }
                    }
                })

            function create_new_html_object(tweet) {

                console.log(tweet)

                let mediaType = undefined
                let mediaUrl = undefined

                try {
                    mediaType = tweet['extended_tweet']['entities']['media'][0]['type']
                    mediaUrl = tweet['extended_tweet']['entities']['media'][0]['media_url']
                } catch(TypeError) {
                    mediaType = null
                    mediaUrl = null
                }


                let authorProfileImage = tweet['user']['profile_image_url']
                let authorDisplayName = tweet['user']['name']
                let authorHandle = tweet['user']['screen_name']

                let tweetText = tweet['text']
                let tweetHashtags = tweet['entities']['hashtags']
                let tweetLink = tweet['entities']['urls']

                let tweetReplyCount = tweet['reply_count']
                let tweetRetweetCount = tweet['retweet_count']
                let tweetLikeCount = tweet['favorite_count']
                let tweetScore = 200


                let html = `

                    <div class="tweet-container">

                        ${mediaType === 'photo' ? `<img class="tweet-media" src="${mediaUrl}" alt="The image attached to the tweet.">` : ''}

                        <div class="tweet-content">

                            <div class="columns is-multiline is-vcentered mb-0">

                                <div class="tweet-profile-pic column is-narrow pr-1">
                                    <img src="${authorProfileImage}" alt="Profile picture for tweet author.">
                                </div>

                                <div class="tweet-user-details column is-narrow pl-1">
                                    <div>${authorDisplayName}</div>
                                    <div>${authorHandle}</div>
                                </div>

                                <div class="column is-narrow">
                                    <span class="icon-text tweet-track-button">
                                        <span class="icon">
                                            <img src="{{ url_for('static', filename='images/icons/Plus-Icon.png') }}" alt="Button to track this handle.">
                                        </span>
                                        <span>TRACK</span>
                                    </span>
                                </div>

                            </div>

                            <p class="tweet-text">
                                ${tweetText}
                            </p>

                            ${tweetHashtags}

                            ${tweetLink}

                            <div class="columns mt-1">
                                <div class="tweet-twitter-metrics column">
                                    <span class="icon-text">
                                        <span class="icon">
                                            <svg viewBox="0 0 24 24" aria-hidden="true" class="r-4qtqp9 r-yyyyoo r-1xvli5t r-dnmrzs r-bnwqim r-1plcrui r-lrvibr r-1hdv0qi"><g><path d="M14.046 2.242l-4.148-.01h-.002c-4.374 0-7.8 3.427-7.8 7.802 0 4.098 3.186 7.206 7.465 7.37v3.828c0 .108.044.286.12.403.142.225.384.347.632.347.138 0 .277-.038.402-.118.264-.168 6.473-4.14 8.088-5.506 1.902-1.61 3.04-3.97 3.043-6.312v-.017c-.006-4.367-3.43-7.787-7.8-7.788zm3.787 12.972c-1.134.96-4.862 3.405-6.772 4.643V16.67c0-.414-.335-.75-.75-.75h-.396c-3.66 0-6.318-2.476-6.318-5.886 0-3.534 2.768-6.302 6.3-6.302l4.147.01h.002c3.532 0 6.3 2.766 6.302 6.296-.003 1.91-.942 3.844-2.514 5.176z"></path></g></svg>
                                        </span>
                                        <span>${tweetReplyCount}</span>
                                    </span>
                                    <span class="icon-text">
                                        <span class="icon">
                                            <svg viewBox="0 0 24 24" aria-hidden="true" class="r-4qtqp9 r-yyyyoo r-1xvli5t r-dnmrzs r-bnwqim r-1plcrui r-lrvibr r-1hdv0qi"><g><path d="M23.77 15.67c-.292-.293-.767-.293-1.06 0l-2.22 2.22V7.65c0-2.068-1.683-3.75-3.75-3.75h-5.85c-.414 0-.75.336-.75.75s.336.75.75.75h5.85c1.24 0 2.25 1.01 2.25 2.25v10.24l-2.22-2.22c-.293-.293-.768-.293-1.06 0s-.294.768 0 1.06l3.5 3.5c.145.147.337.22.53.22s.383-.072.53-.22l3.5-3.5c.294-.292.294-.767 0-1.06zm-10.66 3.28H7.26c-1.24 0-2.25-1.01-2.25-2.25V6.46l2.22 2.22c.148.147.34.22.532.22s.384-.073.53-.22c.293-.293.293-.768 0-1.06l-3.5-3.5c-.293-.294-.768-.294-1.06 0l-3.5 3.5c-.294.292-.294.767 0 1.06s.767.293 1.06 0l2.22-2.22V16.7c0 2.068 1.683 3.75 3.75 3.75h5.85c.414 0 .75-.336.75-.75s-.337-.75-.75-.75z"></path></g></svg>
                                        </span>
                                        <span>${tweetRetweetCount}</span>
                                    </span>
                                    <span class="icon-text">
                                        <span class="icon">
                                            <svg viewBox="0 0 24 24" aria-hidden="true" class="r-4qtqp9 r-yyyyoo r-1xvli5t r-dnmrzs r-bnwqim r-1plcrui r-lrvibr r-1hdv0qi"><g><path d="M12 21.638h-.014C9.403 21.59 1.95 14.856 1.95 8.478c0-3.064 2.525-5.754 5.403-5.754 2.29 0 3.83 1.58 4.646 2.73.814-1.148 2.354-2.73 4.645-2.73 2.88 0 5.404 2.69 5.404 5.755 0 6.376-7.454 13.11-10.037 13.157H12zM7.354 4.225c-2.08 0-3.903 1.988-3.903 4.255 0 5.74 7.034 11.596 8.55 11.658 1.518-.062 8.55-5.917 8.55-11.658 0-2.267-1.823-4.255-3.903-4.255-2.528 0-3.94 2.936-3.952 2.965-.23.562-1.156.562-1.387 0-.014-.03-1.425-2.965-3.954-2.965z"></path></g></svg>
                                        </span>
                                        <span>${tweetLikeCount}</span>
                                    </span>
                                </div>
                                <div class="tweet-score column is-4 has-text-right">
                                    <span>TS</span>
                                    <span>${tweetScore}</span>
                                </div>
                            </div>

                        </div>

                        <hr class="tweet-horizontal-line" />

                        <div class="tweet-filter-controls columns is-multiline is-vcentered has-text-left m-1">
                            <div class="column is-narrow">
                                <span class="icon-text" onclick="{# Add a function here that uses fetch to communicate with our api, then flash the response from the api on screen #}">
                                    <span class="icon">
                                        <img src="{{ url_for('static', filename='images/icons/Plus-Icon.png') }}" alt="">
                                    </span>
                                    <span>LOCKER</span>
                                </span>
                            </div>

                            <div class="column is-narrow">
                                <span class="icon-text" onclick="{# Add a function here that uses fetch to communicate with our api, then flash the response from the api on screen #}">
                                    <span class="icon">
                                        <img src="{{ url_for('static', filename='images/icons/Plus-Icon.png') }}" alt="">
                                    </span>
                                    <span>KEYWORDS</span>
                                </span>
                            </div>

                            <div class="column is-narrow">
                                <span class="icon-text" onclick="{# Add a function here that uses fetch to communicate with our api, then flash the response from the api on screen #}">
                                    <span class="icon">
                                        <img src="{{ url_for('static', filename='images/icons/Plus-Icon.png') }}" alt="">
                                    </span>
                                    <span>HASHTAGS</span>
                                </span>
                            </div>
                        </div>
                        {##}

                    </div>

                `

                let newElement = document.createElement('div')
                newElement.innerHTML = html
                document.getElementById('tweet-wall').insertBefore(newElement, document.querySelector('#tweet-wall > div'))
            }
        }
    </script>

{% endmacro %}